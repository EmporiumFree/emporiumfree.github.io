<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Spotify – Now Playing (Tenacity style)</title>
  <!-- Google Font -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b0c0f;
      --panel:#0f1113;
      --muted:#8b94a0;
      --accent:#6ee7b7;
      --glass: rgba(255,255,255,0.03);
      --radius:14px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(180deg,#060607 0%, #0b0c0f 100%);
      color: #eaf0f3;
      display:flex;align-items:center;justify-content:center;padding:24px;
      -webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;
    }

    .shell{
      width:380px; max-width:96vw; border-radius:var(--radius); overflow:hidden; box-shadow: 0 10px 30px rgba(2,6,10,0.6);
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border:1px solid rgba(255,255,255,0.04);
    }

    header.top{
      display:flex;align-items:center;gap:12px;padding:14px 16px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent);
    }
    .logo{
      width:38px;height:38px;border-radius:9px;background:linear-gradient(135deg,var(--panel),#111316);display:inline-grid;place-items:center;border:1px solid rgba(255,255,255,0.03);
      font-weight:800;color:var(--accent);font-size:18px;letter-spacing:0.6px;
    }
    .brand{font-weight:700;font-size:14px}
    .sub{font-size:12px;color:var(--muted)}

    main.card{
      display:grid;grid-template-columns:110px 1fr;gap:14px;padding:18px;background:linear-gradient(180deg, rgba(255,255,255,0.006), rgba(255,255,255,0.004));
    }
    .cover{
      width:110px;height:110px;border-radius:10px;object-fit:cover;background:linear-gradient(180deg,#0c0d10,#131417);border:1px solid rgba(255,255,255,0.03);
      opacity:0;transform:scale(0.9);transition:opacity 0.4s ease, transform 0.4s ease;
    }
    .cover.show{
      opacity:1;transform:scale(1);
      animation: pulse 2.5s infinite ease-in-out;
    }

    @keyframes pulse {
      0% { box-shadow:0 0 0 0 rgba(110,231,183,0.4); }
      70% { box-shadow:0 0 0 20px rgba(110,231,183,0); }
      100% { box-shadow:0 0 0 0 rgba(110,231,183,0); }
    }

    .meta{display:flex;flex-direction:column;justify-content:center;gap:6px}
    .title{font-size:16px;font-weight:800;letter-spacing:0.2px}
    .artist{font-size:13px;color:var(--muted)}
    .album{font-size:12px;color:var(--muted)}

    .progress{margin-top:12px;height:7px;background:var(--glass);border-radius:999px;overflow:hidden;border:1px solid rgba(255,255,255,0.02)}
    .bar{height:100%;width:0%;background:linear-gradient(90deg,var(--accent), #34d399)}

    footer.controls{display:flex;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid rgba(255,255,255,0.02)}
    .left{display:flex;gap:10px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:8px 12px;border-radius:10px;color:inherit;font-weight:600;font-size:13px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent), #34d399);color:#082018;border:none}
    .status{font-size:13px;color:var(--muted)}

    .muted{color:var(--muted)}

    @media (max-width:420px){ .cover{width:100%;height:auto;aspect-ratio:1/1} main.card{grid-template-columns:1fr} }
  </style>
</head>
<body>
  <div class="shell">
    <header class="top">
      <div class="logo">T</div>
      <div>
        <div class="brand">Now Playing</div>
        <div class="sub">Estética Tenacity — simple y agradable</div>
      </div>
    </header>

    <main class="card">
      <img id="cover" class="cover" alt="Carátula" src="" />
      <section class="meta">
        <div id="stateLabel" class="status">Desconectado</div>
        <div class="title" id="track">—</div>
        <div class="artist" id="artist">—</div>
        <div class="album" id="album">—</div>
        <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
      </section>
    </main>

    <footer class="controls">
      <div class="left">
        <button id="loginBtn" class="btn">Iniciar sesión</button>
        <button id="logoutBtn" class="btn" style="display:none">Salir</button>
      </div>
      <div class="right">
        <div class="status muted small">Consejo: activa Spotify en otro dispositivo</div>
      </div>
    </footer>
  </div>

  <script>
  const CLIENT_ID = "491fcc358ddb4bcbb71f82d6aa2917bd";
  const SCOPES = ["user-read-currently-playing","user-read-playback-state","user-read-recently-played"];
  const REDIRECT_URI = window.location.origin + window.location.pathname;

  function randString(len){ const cs = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~'; let r=''; const a=new Uint8Array(len); crypto.getRandomValues(a); a.forEach(v=>r+=cs[v%cs.length]); return r }
  async function sha256(p){ const e=new TextEncoder(); const d=e.encode(p); const h=await crypto.subtle.digest('SHA-256',d); return new Uint8Array(h) }
  function base64url(b){ let s=btoa(String.fromCharCode(...b)); return s.replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'') }
  async function createChallenge(v){ return base64url(await sha256(v)) }

  function save(k,v){ localStorage.setItem(k, typeof v === 'string' ? v : JSON.stringify(v)); }
  function read(k){ try{ const v=localStorage.getItem(k); return v }catch{return null} }
  function clearAuth(){ ['access_token','expires_at','code_verifier'].forEach(k=>localStorage.removeItem(k)); }
  function tokenValid(){ const t=read('access_token'); const e=Number(read('expires_at')||0); return !!t && Date.now()<e }

  async function login(){
    if(!CLIENT_ID || CLIENT_ID.includes('PON_AQUI')){ alert('Agrega tu CLIENT_ID en el código'); return }
    const verifier = randString(64);
    const challenge = await createChallenge(verifier);
    save('code_verifier', verifier);
    const params = new URLSearchParams({ response_type:'code', client_id:CLIENT_ID, scope:SCOPES.join(' '), redirect_uri:REDIRECT_URI, code_challenge_method:'S256', code_challenge:challenge });
    window.location = `https://accounts.spotify.com/authorize?${params.toString()}`;
  }

  async function exchangeToken(code){
    const verifier = read('code_verifier');
    const body = new URLSearchParams({ client_id:CLIENT_ID, grant_type:'authorization_code', code, redirect_uri:REDIRECT_URI, code_verifier:verifier });
    const res = await fetch('https://accounts.spotify.com/api/token',{ method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body });
    if(!res.ok) throw new Error('Error al intercambiar token');
    const json = await res.json();
    const expiresAt = Date.now() + (json.expires_in * 1000) - 5000;
    save('access_token', json.access_token); save('expires_at', String(expiresAt));
  }

  async function fetchJSON(url){ const res = await fetch(url, { headers: { Authorization: `Bearer ${read('access_token')}` }}); if(res.status===204) return null; if(!res.ok) throw new Error(await res.text()); return res.json(); }
  function msToTime(ms){ const m=Math.floor(ms/60000); const s=Math.floor((ms%60000)/1000).toString().padStart(2,'0'); return `${m}:${s}` }

  let lastTrackId = null;

  function renderState({ isPlaying=false, track='—', artist='—', album='—', cover='', progressMs=0, durationMs=0, label='—', trackId='' }){
    document.getElementById('stateLabel').textContent = label;
    document.getElementById('track').textContent = track;
    document.getElementById('artist').textContent = artist;
    document.getElementById('album').textContent = album;

    const coverEl = document.getElementById('cover');
    if(trackId !== lastTrackId){
      coverEl.classList.remove('show');
      setTimeout(()=>{
        coverEl.src = cover || '';
        coverEl.onload = ()=> coverEl.classList.add('show');
      },150);
      lastTrackId = trackId;
    }

    const pct = durationMs ? Math.min(100, Math.round(progressMs / durationMs * 100)) : 0;
    document.getElementById('bar').style.width = pct + '%';
  }

  async function loadPlayback(){
    try{
      const now = await fetchJSON('https://api.spotify.com/v1/me/player/currently-playing');
      if(now && now.item){ const t = now.item; renderState({ isPlaying: now.is_playing, track: t.name, artist: t.artists.map(a=>a.name).join(', '), album: `${t.album.name} • ${msToTime(t.duration_ms)}`, cover: t.album.images?.[1]?.url || t.album.images?.[0]?.url || '', progressMs: now.progress_ms||0, durationMs: t.duration_ms, label: now.is_playing ? 'Reproduciendo ahora' : 'En pausa', trackId: t.id }); return; }
      const recent = await fetchJSON('https://api.spotify.com/v1/me/player/recently-played?limit=1'); const t = recent?.items?.[0]?.track;
      if(t){ renderState({ track: t.name, artist: t.artists.map(a=>a.name).join(', '), album: `${t.album.name} • ${msToTime(t.duration_ms)}`, cover: t.album.images?.[1]?.url || t.album.images?.[0]?.url || '', progressMs: 0, durationMs: t.duration_ms, label: 'Último reproducido', trackId: t.id }); return; }
      renderState({ label: 'Sin historial' });
    }catch(err){ console.error(err); renderState({ label: 'Error al cargar' }); }
  }

  function syncUI(){ const logged = tokenValid(); document.getElementById('loginBtn').style.display = logged ? 'none' : 'inline-block'; document.getElementById('logoutBtn').style.display = logged ? 'inline-block' : 'none'; }

  async function init(){ const url = new URL(window.location.href); const code = url.searchParams.get('code'); const error = url.searchParams.get('error'); if(error){ renderState({ label: 'Acceso denegado' }); }
    if(code){ try{ await exchangeToken(code); }catch(e){ console.error(e); renderState({ label: 'No se pudo iniciar sesión' }); } finally{ window.history.replaceState({}, document.title, REDIRECT_URI); } }
    syncUI(); if(tokenValid()){ await loadPlayback(); setInterval(loadPlayback,12000); }
  }

  document.getElementById('loginBtn').addEventListener('click', login);
  document.getElementById('logoutBtn').addEventListener('click', ()=>{ clearAuth(); syncUI(); renderState({ label:'Desconectado' }); });
  init();
  </script>
</body>
</html>
